 Code Review Prompt

## 目标
对指定的代码模块或代码块进行全面的代码审查，确保代码质量、正确性和可维护性。

## 审查流程

### 1. 代码理解和意图分析
- **功能目标**: 分析代码的主要功能和预期行为
- **业务逻辑**: 理解代码在整个系统中的作用和业务价值
- **接口设计**: 检查输入输出参数、返回值和异常处理
- **依赖关系**: 识别外部依赖和内部模块耦合
- **调用时机**: 分析代码被调用的时机和触发条件是否合理
- **执行上下文**: 检查代码在特定上下文中执行是否适当

### 2. 实现正确性检查
- **逻辑正确性**: 验证算法和业务逻辑的正确实现
- **边界条件**: 检查边界值处理和异常情况
- **数据流**: 追踪数据在函数/模块中的流转过程
- **状态管理**: 检查状态变化和副作用处理
- **原子性操作**: 检查数据库操作和状态更新的原子性，避免部分状态问题
- **冗余操作**: 识别重复的数据库查询、网络调用或计算操作

### 3. 代码质量评估
- **可读性**: 代码结构清晰、命名规范、注释充分
- **可维护性**: 模块化设计、职责单一、易于扩展
- **性能考虑**: 时间复杂度、空间复杂度、资源使用
- **安全性**: 输入验证、权限检查、敏感数据处理

### 4. 优化建议
- **重复代码**: 识别重复逻辑并建议重构
- **逻辑漏洞**: 发现未考虑的边界情况和异常处理
- **设计模式**: 建议合适的设计模式和架构优化
- **最佳实践**: 对照语言和框架的最佳实践
- **操作原子性**: 检查是否存在应该合并的多步操作，确保状态一致性
- **资源效率**: 识别不必要的重复查询、计算或资源分配

## 输出要求

### 1. 代码流程图
使用 Mermaid 图表展示：
- **数据流图**: 展示数据在系统中的流转过程
- **逻辑流程图**: 展示主要的业务逻辑和控制流程
- **调用关系图**: 展示函数/模块之间的调用关系

### 2. 审查报告
结构化的审查报告包含：

#### 代码概览
- 功能描述
- 主要组件和职责
- 关键技术实现

#### 正确性分析
- ✅ 实现正确的部分
- ❌ 存在问题的部分
- ⚠️ 需要关注的潜在问题

#### 优化建议
- 🔄 代码重构建议
- 🚀 性能优化建议
- 🔒 安全性改进建议
- 📚 可维护性提升建议
- ⚛️ 原子性和一致性优化
- 🎯 冗余消除建议

#### 具体修改建议
- 提供具体的代码修改示例
- 解释修改的原因和预期效果
- 给出修改的优先级

## 审查标准

### 代码质量标准
- **清晰性**: 代码意图明确，易于理解
- **一致性**: 遵循项目编码规范
- **简洁性**: 避免不必要的复杂性
- **健壮性**: 处理异常情况和边界条件

### 检查要点
- [ ] 函数/方法职责单一
- [ ] 变量命名语义明确
- [ ] 错误处理完整
- [ ] 输入验证充分
- [ ] 资源管理正确（内存、文件、连接等）
- [ ] 并发安全（如适用）
- [ ] 测试覆盖充分
- [ ] 数据库操作原子性（事务、一致性状态）
- [ ] 避免冗余的数据查询或计算
- [ ] 状态更新的完整性和一致性
- [ ] 函数间的数据传递效率
- [ ] 业务逻辑触发时机合理
- [ ] 模块职责边界清晰
- [ ] 调用上下文与业务逻辑匹配

## 特殊关注点审查清单

### 数据库操作模式
- **原子性检查**: 相关的数据库操作是否应该在同一个事务中完成？
- **状态一致性**: 是否存在两步操作导致的中间状态不一致问题？
- **冗余查询**: 是否存在重复的数据库查询可以合并或缓存？
- **更新逻辑**: 数据更新是否可以作为创建/修改操作的一部分？

### 函数调用关系
- **参数传递**: 是否存在重复获取相同数据的情况？
- **返回值利用**: 函数返回的数据是否被充分利用？
- **调用顺序**: 函数调用顺序是否合理，能否优化？
- **错误传播**: 错误处理是否在合适的层级进行？

### 业务逻辑审查重点
- **操作合并**: 多个相关操作是否可以合并为一个原子操作？
- **状态管理**: 状态变更是否有完整的事务边界？
- **副作用**: 副作用操作是否在主要操作成功后进行？
- **回滚机制**: 是否有适当的错误恢复机制？
- **触发时机合理性**: 业务逻辑是否在正确的时机和上下文中触发？
- **职责边界**: 当前模块是否承担了不属于其职责范围的业务逻辑？

### 代码重构信号
- **重复模式**: 相似的代码模式是否可以抽象？
- **分离关注点**: 是否存在应该分离的不同职责？
- **依赖注入**: 硬编码的依赖是否应该通过参数传递？
- **配置外化**: 魔法数字或字符串是否应该配置化？

### 调用时机和职责审查
- **触发条件**: 业务逻辑的触发条件是否合理和充分？
- **执行时机**: 操作是否在正确的生命周期阶段执行？
- **上下文匹配**: 当前执行上下文是否适合执行该业务逻辑？
- **模块职责**: 当前模块是否承担了超出其职责范围的业务逻辑？
- **业务完整性**: 相关的业务操作是否应该在同一个处理流程中完成？
- **依赖关系**: 业务逻辑是否过度依赖于特定的技术实现细节？

## 审查执行提示

1. **深入分析**: 不要仅仅查看表面功能，要分析操作之间的关系
2. **状态跟踪**: 跟踪数据在整个流程中的状态变化
3. **原子性思考**: 思考哪些操作应该是原子的，哪些可以分离
4. **效率优化**: 识别可以减少资源消耗的机会
5. **一致性保证**: 确保所有状态更新都是一致和完整的
6. **调用时机审查**: 重点关注业务逻辑是否在合适的时机和上下文中执行
7. **职责分离检查**: 验证每个模块是否只处理其职责范围内的逻辑

将要审查的代码粘贴到对话中，并说明：
1. 代码的背景和用途
2. 特别关注的审查点
3. 已知的问题或疑虑

系统将按照上述流程进行全面的代码审查，并提供详细的分析报告和改进建议。

